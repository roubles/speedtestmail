#!/usr/bin/env bash

echoerr() { echo "$@" 1>&2; }
if [ ! -e /usr/local/bin/speedtest-cli ]; then
    echoerr "Please install speedtest-cli from https://github.com/sivel/speedtest-cli"
    exit 1
fi

echo "Getting speedtest metrics..."
data=$("/usr/local/bin/speedtest-cli")

hostname=$(hostname)
echo "Hostname: $hostname"

updown=$(echo "$data" | awk '/Upload|Download/' | paste -s -d ", " -  )
echo "Speed: $updown"

ipline=$(echo "$data" | grep "Testing from")
ipline=${ipline##* } #Extract IP from 
ip=${ipline%%...} 
echo "External IP: $ip"

subject="$hostname$ip: $updown"

for i in $(echo $1 | sed "s/,/ /g")
do
    echo "Sending mail with $subject to $i"
    echo "$data" | mail -s "$subject" $i
done
